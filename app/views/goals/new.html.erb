<%= javascript_include_tag "http://code.jquery.com/jquery-1.7.1.min.js", "https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js", "rails.js" %>

<h1>Create A Goal</h1>
<div id="goaldebug"></div>
<%= form_for @goal do |f| %>
  <%= render 'shared/error_messages', :object => f.object %>
  <div class="allgoalinfo">
    <div class="round goalfields">
      <%= f.text_field :title, :class => "round goaltitleinput goalfont", :placeholder => "Enter Goal Title" %><br>
      <%= f.text_area  :description, :class => "round goaldescinput goalfont", :placeholder => "Enter Goal Description" %><br>
    </div>
    <div id="milestones">
      <% idcounter = 0 %>
      <%= f.fields_for :milestones do |builder| %>
        <li class ="round milefields" id="<%=idcounter%>">
          <div class="fadebox">
            <button class="add" type="button">+</button>
            <button class="remove" type="button">x</button>
          </div>
          <%= builder.text_field :title, :class => "round miletitleinput goalfont", :placeholder => "Enter Title" %>  <br/>
          <%= builder.text_area :description, :class => "round miledescinput goalfont", :placeholder => "Enter Description" %>
        </li>
        <% idcounter += 1 %>
      <% end %>
    </div>
    <div class="actions">
      <%= f.submit "Create" %>
    </div>
  </div>
<% end %>


<% content_for :javascript do %>
  <% javascript_tag do %>
     $('#milestones').sortable(
        {
          axis: 'y',
          dropOnEmpty:false,
          cursor: 'crosshair',
          items: 'li',
          opacity: 0.4,
          scroll: true
          });
 
    $(document).ready(function(){
      // remove  
      $(".remove").live("click",
        function(evt){
          var entered = evt.target;
          while (entered.tagName != "LI") {
            entered = entered.parentNode;
          }
           document.getElementById('goaldebug').innerHTML += ' before remove '+ evt.target.tagName;
          $(entered).remove();
        }
      );
      
      // add 
      $(".add").live("click",
        function(evt){        
          var entered = evt.target;
  
          while (entered.tagName != "LI") {
            entered = entered.parentNode;
            document.getElementById('goaldebug').innerHTML += ' Inside mouseenter '+ entered.tagName;
          } 
          var newElem = $(entered).clone();
          newElem.find('input').val('');
          newElem.attr({
            id: "-1"
            });
          document.getElementById('goaldebug').innerHTML += ' test newElem '+ newElem.tagName
          $(entered).after(newElem);
          //evt.target.attr('disabled','true');
          $(document).ready();
        }
      );
      
      // Hide the fadebox when page load
      $(".fadebox").hide();

      // Fade In when mouse is over
      //$(".milefields").mouseenter(
      $(".milefields").live("mouseenter",
        function(evt){
          var entered = evt.target;
          // fetch the parent if the ID is a child of the LI tag  
          document.getElementById('goaldebug').innerHTML += ' Inside mouseenter... '+" "+ entered.className + " " +entered.tagName;
          if (entered.tagName != "LI") {
            while( (entered.className != "fadebox") ) {
              entered = entered.previousSibling;
              document.getElementById('goaldebug').innerHTML += ' Inside while ... '+" "+ entered.className + " " +entered.tagName;  
            }
          } else {
            entered = entered.firstChild;
            while( (entered.className != "fadebox") ) {
              entered = entered.nextSibling;
            }
              //document.getElementById('goaldebug').innerHTML += ' Inside else... '+" "+ entered.className + " " +entered.tagName;
          }
          $(entered).show();
        }   
      );

      // Fade out when mouse is out
      //$(".milefields").mouseleave(
      $(".milefields").live("mouseleave",
        function(evt){
          $(".fadebox").hide();
        }
      );
    });

    <% end %>
<% end %>